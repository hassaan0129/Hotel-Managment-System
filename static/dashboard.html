<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Hotel Management</title>
    <link rel="stylesheet" href="/assets/style.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 28px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .action-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: 0.3s; }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .action-icon { font-size: 48px; margin-bottom: 15px; }
        .action-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .action-desc { font-size: 14px; color: #666; }
        .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-header { font-size: 24px; font-weight: 600; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .bookings-grid { display: grid; gap: 15px; }
        .booking-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; transition: 0.3s; }
        .booking-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .booking-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .booking-id { font-size: 18px; font-weight: 600; color: #667eea; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-checkedin { background: #cce5ff; color: #004085; }
        .status-checkedout { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .booking-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .booking-detail { font-size: 14px; color: #555; }
        .booking-detail strong { color: #333; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.3s; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-cancel:hover { background: #c82333; }
        .no-bookings { text-align: center; padding: 40px; color: #999; font-size: 16px; }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üè® Guest Dashboard</h1>
            <div class="user-info">
                <span id="userName">Welcome, Guest</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="quick-actions">
            <div class="action-card" onclick="window.location.href='/user_book_room'">
                <div class="action-icon">üõèÔ∏è</div>
                <div class="action-title">Book a Room</div>
                <div class="action-desc">Reserve your perfect room</div>
            </div>
            <div class="action-card" onclick="window.location.href='/user_order_food'">
                <div class="action-icon">üçΩÔ∏è</div>
                <div class="action-title">Order Food</div>
                <div class="action-desc">Delicious meals to your room</div>
            </div>
            <div class="action-card" onclick="window.location.href='/user_view_bill'">
                <div class="action-icon">üí≥</div>
                <div class="action-title">View Bill</div>
                <div class="action-desc">Check your expenses</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">My Bookings</div>
            <div id="bookingsContainer">
                <div class="loading">Loading your bookings...</div>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('userId') || 'user';
        document.getElementById('userName').textContent = `Welcome, ${userId}`;

        async function loadBookings() {
            try {
                const response = await fetch(`/api/bookings/user/${userId}`);
                const data = await response.json();
                const bookings = data.bookings || [];
                
                const container = document.getElementById('bookingsContainer');
                
                if (bookings.length === 0) {
                    container.innerHTML = '<div class="no-bookings">No bookings yet. Book your first room!</div>';
                    return;
                }
                
                container.innerHTML = '<div class="bookings-grid"></div>';
                const grid = container.querySelector('.bookings-grid');
                
                bookings.forEach(booking => {
                    const statusClass = `status-${booking.status.toLowerCase().replace(' ', '')}`;
                    
                    const card = document.createElement('div');
                    card.className = 'booking-card';
                    card.innerHTML = `
                        <div class="booking-header">
                            <div class="booking-id">Booking #${booking.bookingId}</div>
                            <span class="status-badge ${statusClass}">${booking.status}</span>
                        </div>
                        <div class="booking-details">
                            <div class="booking-detail"><strong>Room:</strong> ${booking.roomNumber}</div>
                            <div class="booking-detail"><strong>Check-In:</strong> ${booking.checkInDate}</div>
                            <div class="booking-detail"><strong>Check-Out:</strong> ${booking.checkOutDate}</div>
                            <div class="booking-detail"><strong>Nights:</strong> ${booking.nights}</div>
                            <div class="booking-detail"><strong>Amount:</strong> Rs.${booking.totalAmount}</div>
                            <div class="booking-detail"><strong>Booked On:</strong> ${booking.bookingDate}</div>
                        </div>
                        ${booking.status === 'Confirmed' ? 
                            `<button class="btn btn-cancel" onclick="cancelBooking(${booking.bookingId})" style="margin-top: 15px;">Cancel Booking</button>` 
                            : ''}
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsContainer').innerHTML = 
                    '<div class="no-bookings">Error loading bookings. Please refresh.</div>';
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to cancel this booking?\n\nThis action cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/bookings/cancel/${bookingId}`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success modal instead of alert
                    showSuccessModal('Booking Cancelled', 'Your booking has been successfully cancelled. The room is now available for others.');
                    setTimeout(() => loadBookings(), 1500);
                } else {
                    showErrorModal('Cancellation Failed', result.message || 'Unable to cancel booking. Please contact support.');
                }
            } catch (error) {
                console.error('Cancel error:', error);
                showErrorModal('Error', 'Network error. Please check your connection and try again.');
            }
        }

        // Success Modal
        function showSuccessModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-overlay"></div>
                <div class="modal-box success-modal">
                    <div class="modal-icon">‚úÖ</div>
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <button onclick="this.closest('.custom-modal').remove()" class="btn btn-primary">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 3000);
        }

        // Error Modal
        function showErrorModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-overlay"></div>
                <div class="modal-box error-modal">
                    <div class="modal-icon">‚ùå</div>
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <button onclick="this.closest('.custom-modal').remove()" class="btn btn-danger">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        loadBookings();
    </script>
</body>
</html>